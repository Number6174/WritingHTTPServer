<!doctype html>
<html>
  <head>
    <title>WritingHTTPServer Control Panel</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        div.alert {
            padding: 20px;
            background-color: #f00;
            color: white;
            margin-bottom: 15px;
            display: none;
        }
    </style>

   </head>
  <body>

    <div class="alert" id="alert">
        Error: Unable to connect to script
    </div>

    <h1>Timer Info</h1>

    <h3>Current time:</h3> 
    <div id="time">
        <span id="hours">12</span>:<span id="minutes">59</span>:<span id="seconds">59</span>
    </div>
    <div>
        Funded: <span id="funded"></span> / <span id="to_fully_fund"></span> or <span id="funded_percent"></span> %
    </div>

    <script>
        // Much of the time code is adapted/ripped from https://www.sitepoint.com/build-javascript-countdown-timer-no-dependencies/
        function getTimeRemaining(endtime) {
            const total = Date.parse(endtime) - Date.parse(new Date());
            const seconds = Math.floor((total / 1000) % 60);
            const minutes = Math.floor((total / 1000 / 60) % 60);
            const hours = Math.floor((total / (1000 * 60 * 60)) % 24);

            return {
                total,
                hours,
                minutes,
                seconds
            };
        }
        function updateClock() {
            const t = getTimeRemaining(endtime);
            if (t.total <= 0) {
                t.hours = 0;
                t.minutes = 0;
                t.seconds = 0;
            }
            hoursSpan.innerHTML = t.hours;
            minutesSpan.innerHTML = ('0' + t.minutes).slice(-2);
            secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);
        }
        function updateFromServer() {
            jQuery.ajax({
                url: '/api/timer',
                dataType: 'json'
            })
            .done(function (data) {
                document.getElementById("alert").style.display = 'none';
                endtime = data['current-end'];
                points_funded = data['points-funded'];
                points_to_fully_fund = data['points-to-fully-fund'];
            })
            .fail(function (){
                document.getElementById("alert").style.display = 'block';
            });
        }

        function updatePoints() {
            fundedSpan.innerHTML = points_funded;
            toFundSpan.innerHTML = points_to_fully_fund;
            fundedPercentSpan.innerHTML = points_funded / points_to_fully_fund * 100;
        }

        function update() {
            updateFromServer();
            updateClock();
            updatePoints();
        }

        let endtime = "2021-03-13T17:00:00";
        let points_funded = 0;
        let points_to_fully_fund = 100;
        const clock = document.querySelector("#time");
        const hoursSpan = clock.querySelector('#hours');
        const minutesSpan = clock.querySelector('#minutes');
        const secondsSpan = clock.querySelector('#seconds');
        const fundedSpan = document.querySelector("#funded");
        const toFundSpan = document.querySelector("#to_fully_fund");
        const fundedPercentSpan = document.querySelector("#funded_percent");

        update(); // run function once at first to avoid delay
        setInterval(update, 1000); // 1k = 1s
    </script>

    <h3>Modify the timer</h3>
    Add:
    <br />
    <input type="button" id="timer_add_prime" value="Prime" />
    <input type="button" id="timer_add_t1" value="T1" />
    <input type="button" id="timer_add_t2" value="T2" />
    <input type="button" id="timer_add_t3" value="T3" />

    <br />
    <input type="number" id="timer_bits_qty" /> <input type="button" id="timer_add_bits" value="Bits" />
    <br />
    <input type="number" id="timer_tip_qty" /> <input type="button" id="timer_add_tip" value="Tip" />
    
    <br />
    <br />

    Change: 
    <br />
    Time: <input type="text" id="timer_modify_text" /><input type="button" id="timer_increase_time" value="Increase" /> <input type="button" id="timer_decrease_time" value="Decrease" /> use text like "1h" or "5m" or "1h5m"
    <br />
    Points: <input type="number" id="timer_points_qty" /><input type="button" id="timer_points_set" value="Set" /><input type="button" id="timer_points_increase" value="Increase" /><input type="button" id="timer_points_decrease" value="Decrease" />
    <br />
    

    <script>
        document.getElementById("timer_add_prime").onclick=async () =>{
            jQuery.ajax('/event?name=Fake&sub=1&tier=Prime')
            updateAll()
        };
        document.getElementById("timer_add_t1").onclick=async () =>{
            jQuery.ajax('/event?name=Fake&sub=1&tier=Tier%201')
            updateAll()
        };
        document.getElementById("timer_add_t2").onclick=async () =>{
            jQuery.ajax('/event?name=Fake&sub=1&tier=Tier%202')
            updateAll()
        };
        document.getElementById("timer_add_t3").onclick=async () =>{
            jQuery.ajax('/event?name=Fake&sub=1&tier=Tier%203')
            updateAll()
        };

        document.getElementById("timer_add_bits").onclick=async () =>{
            jQuery.ajax('/event?name=Fake&bits=' + document.getElementById("timer_bits_qty").value  )
            updateAll()
        };
        document.getElementById("timer_add_tip").onclick=async () =>{
            jQuery.ajax('/event?name=Fake&tip=' + document.getElementById("timer_tip_qty").value  )
            updateAll()
        };

        document.getElementById("timer_increase_time").onclick=async () =>{
            jQuery.ajax('/event?time=increase&amount=' + document.getElementById("timer_modify_text").value  )
            updateAll()
        };
        document.getElementById("timer_decrease_time").onclick=async () =>{
            jQuery.ajax('/event?time=decrease&amount=' + document.getElementById("timer_modify_text").value  )
            updateAll()
        };

        document.getElementById("timer_points_set").onclick=async () =>{
            jQuery.ajax('/event?points=set&amount=' + document.getElementById("timer_points_qty").value  )
            updateAll()
        };
        document.getElementById("timer_points_increase").onclick=async () =>{
            jQuery.ajax('/event?points=increase&amount=' + document.getElementById("timer_points_qty").value  )
            updateAll()
        };
        document.getElementById("timer_points_decrease").onclick=async () =>{
            jQuery.ajax('/event?points=decrease&amount=' + document.getElementById("timer_points_qty").value  )
            updateAll()
        };

    </script>

    <h3>Timer Configuration</h3>

    These values will auto-update if you only modify them from this control panel. If they are altered outside this (including by events triggered from another program), you will want to force read before editing

    <h5>Current Stream</h5>
    <input type="button" id="config_current_read" value="Force Read" />
    <input type="button" id="config_current_write" value="Write" />
    <br />
    Stream normally starts at: <input type="datetime-local" id="timer_start_datetime" />
    <br />
    Stream could extend until: <input type="datetime-local" id="timer_stream_end_datetime" />
    <br />
    Current End: <input type="datetime-local" id="timer_stream_current_end_datetime" />
    <br />
    Points funded <input type="number" id="timer_points_funded" /> out of <input type="number" id="timer_points_to_fully_fund" />
    <br />
    Time adjustment <input type="number" id="timer_time_adjust" /> seconds (can be negative value)

    <h5>Every Stream</h5>
    <input type="button" id="config_every_read" value="Force Read" />
    <input type="button" id="config_every_write" value="Write" />
    <br />
    Stream normally starts at <input type="text" id="config_timer_start" />
    <br />
    Initial amount to put on timer <input type="text" id="config_timer_initial" />
    <br />
    Can fund up to <input type="text" id="config_timer_max_fund_time" /> using <input type="number" id="config_timer_max_points" /> points.
    <br />
    Every 100 bits contributes <input type="number" id="config_timer_bits" /> points
    <br />
    Every dollar tip contributes <input type="number" id="config_timer_tips" /> points, with a fee of <input type="number" id="config_timer_tip_fee_percent" /> % + <input type="number" id="config_timer_fee_fixed" /> 
    <br />
    Every Prime sub contributes <input type="number" id="config_timer_prime_sub" /> points
    <br />
    Every T1 sub contributes <input type="number" id="config_timer_t1_sub" /> points
    <br />
    Every T2 sub contributes <input type="number" id="config_timer_t2_sub" /> points
    <br />
    Every T3 sub contributes <input type="number" id="config_timer_t3_sub" /> points

    <script>
        function read_timer_current_config() {
            let resp = jQuery.get('/api/timer')
            
            $.when(resp).done(function(){
                data = resp.responseJSON

                document.getElementById("timer_start_datetime").value = data['stream-start']
                document.getElementById("timer_stream_end_datetime").value = data['stream-end']
                document.getElementById("timer_stream_current_end_datetime").value = data['current-end']
                document.getElementById("timer_points_funded").value = data['points-funded']
                document.getElementById("timer_points_to_fully_fund").value = data['points-to-fully-fund']
                document.getElementById("timer_time_adjust").value = data['time-adjust']
            })
        }

        function read_timer_every_config() {
            let resp = jQuery.get('/api/config')
            
            $.when(resp).done(function(){
                config = resp.responseJSON

                document.getElementById("config_timer_start").value = config['timer']['stream-start']
                document.getElementById("config_timer_initial").value = config['timer']['timer-start']
                document.getElementById("config_timer_max_fund_time").value = config['timer']['time-fundable']
                document.getElementById("config_timer_max_points").value = config['timer']['points-to-fully-fund']

                document.getElementById("config_timer_bits").value = config['event']['per100bits']
                document.getElementById("config_timer_tips").value = config['event']['perdollartip']
                document.getElementById("config_timer_tip_fee_percent").value = config['event']['tip-fee-percent']
                document.getElementById("config_timer_fee_fixed").value = config['event']['tip-fee-fixed']
                document.getElementById("config_timer_prime_sub").value = config['event']['prime-sub']
                document.getElementById("config_timer_t1_sub").value = config['event']['t1-sub']
                document.getElementById("config_timer_t2_sub").value = config['event']['t2-sub']
                document.getElementById("config_timer_t3_sub").value = config['event']['t3-sub']
            })
        }

        document.getElementById("config_current_read").onclick=async () =>{
            read_timer_current_config();
        };
        document.getElementById("config_every_read").onclick=async () =>{
            read_timer_every_config();
        };

        document.getElementById("config_current_write").onclick=async () =>{
            jQuery.ajax({
                url: '/api/configwriter/timer_data',
                method: 'PUT',
                data: JSON.stringify({
                    "stream-start": document.getElementById("timer_start_datetime").value,
                    "stream-end": document.getElementById("timer_stream_end_datetime").value,
                    "current-end": document.getElementById("timer_stream_current_end_datetime").value,
                    "points-funded": parseInt(document.getElementById("timer_points_funded").value),
                    "points-to-fully-fund": parseInt(document.getElementById("timer_points_to_fully_fund").value),
                    "time-adjust": parseInt(document.getElementById("timer_time_adjust").value)
                })
            });
        };

        document.getElementById("config_every_write").onclick=async () =>{
            jQuery.ajax({
                url: '/api/configwriter/config',
                method: 'PUT',
                data: JSON.stringify({
                    "event": {
                        "per100bits": parseInt(document.getElementById("config_timer_bits").value),
                        "perdollartip": parseInt(document.getElementById("config_timer_tips").value),
                        "tip-fee-percent": parseFloat(document.getElementById("config_timer_tip_fee_percent").value),
                        "tip-fee-fixed": parseFloat(document.getElementById("config_timer_fee_fixed").value),
                        "prime-sub": parseInt(document.getElementById("config_timer_prime_sub").value),
                        "t1-sub": parseInt(document.getElementById("config_timer_t1_sub").value),
                        "t2-sub": parseInt(document.getElementById("config_timer_t2_sub").value),
                        "t3-sub": parseInt(document.getElementById("config_timer_t3_sub").value)
                    },
                    "timer": {
                        "stream-start": document.getElementById("config_timer_start").value,
                        "timer-start": document.getElementById("config_timer_initial").value,
                        "time-fundable": document.getElementById("config_timer_max_fund_time").value,
                        "points-to-fully-fund": parseInt(document.getElementById("config_timer_max_points").value)
                    }
                })
            });
        };


        function updateAll() {
            update() // Timer
            read_timer_current_config()
            read_timer_every_config()
        }

        // Onload
        updateAll()
    </script>

    <h1>Keypress</h1>

    Valid keys are a-z, 0-9, f1-f20.
    <br />
    Modifiers:
    <input type="checkbox" id="keypress_mod_alt" /> alt
    <input type="checkbox" id="keypress_mod_alt_gr" /> alt_gr
    <input type="checkbox" id="keypress_mod_alt_l" /> alt_l
    <input type="checkbox" id="keypress_mod_alt_r" /> alt_r
    <input type="checkbox" id="keypress_mod_ctrl" /> ctrl
    <input type="checkbox" id="keypress_mod_ctrl_l" /> ctrl_l
    <input type="checkbox" id="keypress_mod_ctrl_r" /> ctrl_r
    <input type="checkbox" id="keypress_mod_shift" /> shift
    <input type="checkbox" id="keypress_mod_shift_l" /> shift_l
    <input type="checkbox" id="keypress_mod_shift_r" /> shift_r
    <input type="checkbox" id="keypress_mod_super" /> super
    <br />
    Repeat: <input type="number" id="keypress_repeat" value=1 />
    <br />
    Key: <input type="text" id="keypress_input" /> <input type="button" id="kepress_test" value="Test" />
    <br />
    Corresponding URL: <input type="text" id="keypress_url" />

    <script>
        document.getElementById("kepress_test").onclick=async () =>{
            let path = '/keypress?key=' + document.getElementById("keypress_input").value
            if (document.getElementById("keypress_mod_alt").checked) {
                path += '&mode=alt'
            }
            if (document.getElementById("keypress_mod_alt_gr").checked) {
                path += '&mode=alt_gr'
            }
            if (document.getElementById("keypress_mod_alt_l").checked) {
                path += '&mode=alt_l'
            }
            if (document.getElementById("keypress_mod_alt_r").checked) {
                path += '&mode=alt_r'
            }
            if (document.getElementById("keypress_mod_ctrl").checked) {
                path += '&mode=ctrl'
            }
            if (document.getElementById("keypress_mod_ctrl_l").checked) {
                path += '&mode=ctrl_l'
            }
            if (document.getElementById("keypress_mod_ctrl_r").checked) {
                path += '&mode=ctrl_r'
            }
            if (document.getElementById("keypress_mod_shift").checked) {
                path += '&mode=shift'
            }
            if (document.getElementById("keypress_mod_shift_l").checked) {
                path += '&mode=shift_l'
            }
            if (document.getElementById("keypress_mod_shift_r").checked) {
                path += '&mode=shift_r'
            }
            if (document.getElementById("keypress_mod_super").checked) {
                path += '&mode=super'
            }

            if (document.getElementById("keypress_repeat").value != 1) {
                path += '&repeat=' + document.getElementById("keypress_repeat").value
            }
            jQuery.ajax(path)

            document.getElementById("keypress_url").value = window.location.href + path
        }
    </script>


    <h1>File Writing</h1>
    This does not write to any file, but just aid in providing a partial URL. Due to the browser security it will always show the file as being in C:\fakepath\, but it will show the pattern to use. Also replace <tt>foo</tt> with the data you wish to write out.

    <br />
    <br />

    I want to write to the file: <input type="file" id="file_name" />
    <br />
    I want to <input type="radio" name="file_mode" /> overwrite <input type="radio" name="file_mode" id="file_mode_append" /> append
    <br />
    <input type="checkbox" id="file_log" /> Include timestamps?
    <br />
    <input type="button" id="file_button" value="Generate URL" /> <input type="text" id="file_textbox" />

    <script>
        document.getElementById("file_button").onclick=async () =>{
            const host = window.location.href
            const filename = encodeURI(document.getElementById("file_name").value)
            let url = host + 'write?filename=' + filename

            if (document.getElementById("file_mode_append").checked) {
                url += '&mode=a'
            }
            if (document.getElementById("file_log").checked) {
                url += '&log=true'
            }

            url += '&data=foo'

            document.getElementById("file_textbox").value = url
        };
    </script>
  </body>
</html>